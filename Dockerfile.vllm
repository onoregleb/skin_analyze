FROM nvidia/cuda:12.1.1-cudnn8-runtime-ubuntu22.04

ENV DEBIAN_FRONTEND=noninteractive
RUN apt-get update && apt-get install -y python3 python3-pip git curl && rm -rf /var/lib/apt/lists/*

RUN pip3 install --no-cache-dir vllm torch transformers safetensors accelerate

ARG VLLM_API_KEY=dev
ARG QWEN_MODEL=Qwen/Qwen3-4B-Instruct-2507

ENV VLLM_API_KEY=${VLLM_API_KEY}
ENV QWEN_MODEL=${QWEN_MODEL}

EXPOSE 8002

HEALTHCHECK --interval=30s --timeout=30s --start-period=300s --retries=3 \
    CMD curl -f http://localhost:8002/health || exit 1

CMD ["sh", "-c", "python3 -m vllm.entrypoints.openai.api_server --model $QWEN_MODEL --port 8002 --api-key $VLLM_API_KEY --trust-remote-code --gpu-memory-utilization 0.9 --max-model-len 78912"]
